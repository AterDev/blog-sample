@* TypeScript for list page (keeps imports and formatting) *@
@{
  var name = ModelName ?? "Model";
  var camel = (ModelName ?? "Model").ToCamelCase();
  var module = (Namespace ?? string.Empty).Split('.').LastOrDefault()?.ToHyphen() ?? string.Empty;
  var hasEnumFilter = FilterPropertyInfos.Any(p => p.IsEnum);
  var hasIdFilter = FilterPropertyInfos.Any(p => p.Type != null && p.Type.ToLower().Contains("guid"));
  var idFilterFields = FilterPropertyInfos.Where(p => p.Type != null && p.Type.ToLower().Contains("guid")).ToList();
  var enumImports = hasEnumFilter ? ", ToKeyValuePipe, EnumTextPipe" : string.Empty;
}
import { Component, OnInit } from '@@angular/core';
import { MatDialog } from '@@angular/material/dialog';
import { MatTableDataSource } from '@@angular/material/table';
import { TranslateService } from '@@ngx-translate/core';
import { AdminClient } from 'src/app/services/admin/admin-client';
import { I18N_KEYS } from 'src/app/share/i18n-keys';
import { CommonFormModules, CommonListModules } from 'src/app/share/shared-modules';
@{ if (hasEnumFilter) { WriteLiteral("import { ToKeyValuePipe } from 'src/app/share/pipe/to-key-value.pipe';\n"); WriteLiteral("import { EnumTextPipe } from 'src/app/pipe/admin/enum-text.pipe';\n"); } }
@{ if (hasIdFilter) { WriteLiteral("import { forkJoin, Observable } from 'rxjs';\n"); WriteLiteral("import { PageList } from 'src/app/services/admin/models/perigon/page-list.model';\n"); } }
@{ 
  foreach (var field in idFilterFields) 
  { 
    var navigationName = field.NavigationName ?? field.Name.Replace("Id", "");
    var pascalNavigationName = navigationName.Substring(0, 1).ToUpper() + navigationName.Substring(1);
    var itemDtoType = pascalNavigationName + "ItemDto";
    var moduleName = (Namespace ?? string.Empty).Split('.').FirstOrDefault()?.ToLower() ?? string.Empty;
    WriteLiteral($"import {{ {itemDtoType} }} from 'src/app/services/admin/models/{moduleName}-mod/{navigationName.ToHyphen()}-item-dto.model';\n");
  }
}
import { ConfirmDialogComponent } from 'src/app/share/components/confirm-dialog/confirm-dialog.component';
import { @(ModelName)FilterDto } from 'src/app/services/admin/models/@(module)/@(ModelName.ToHyphen())-filter-dto.model';
import { @(ModelName)ItemDto } from 'src/app/services/admin/models/@(module)/@(ModelName.ToHyphen())-item-dto.model';
import { @(ModelName)Add } from './add';
import { @(ModelName)Edit } from './edit';
import { @(ModelName)Detail } from './detail';

@{ WriteLiteral("@Component({\n  selector: 'app-" + camel + "-index',\n  imports: [CommonListModules, CommonFormModules" + enumImports + "],\n  templateUrl: './index.html'\n})\n"); }
export class @(ModelName)Index implements OnInit {

  i18nKeys = I18N_KEYS;

  filter: @(ModelName)FilterDto = { pageIndex: 1, pageSize: 10 };
  dataSource = new MatTableDataSource<@(ModelName)ItemDto>();
  displayedColumns = [ @( string.Join(", ", ItemPropertyInfos.Select(c => $"\"{c.Name}\"")) ), "actions" ];

  total = 0;
  pageSize = 10;
@{ 
  foreach (var field in idFilterFields) 
  { 
    var navigationName = field.NavigationName ?? field.Name.Replace("Id", "");
    var pascalNavigationName = navigationName.Substring(0, 1).ToUpper() + navigationName.Substring(1);
    var itemDtoType = pascalNavigationName + "ItemDto";
    WriteLiteral($"  {field.Name.ToCamelCase()}Options: {itemDtoType}[] = [];\n");
  } 
}

  constructor(
    private adminClient: AdminClient,
    private dialog: MatDialog,
    private translate: TranslateService
  ) { }

  ngOnInit(): void {
@{ 
  if (idFilterFields.Count > 0) 
  { 
    WriteLiteral("    const requests: Observable<PageList<any>>[] = [];\n");
    foreach (var field in idFilterFields)
    {
      var camelField = field.Name.ToCamelCase();
      WriteLiteral($"    requests.push(this.get{field.Name}());\n");
    }
    WriteLiteral("    forkJoin(requests).subscribe({\n");
    WriteLiteral("      next: (results) => {\n");
    for (int i = 0; i < idFilterFields.Count; i++)
    {
      var camelField = idFilterFields[i].Name.ToCamelCase();
      WriteLiteral($"        this.{camelField}Options = results[{i}].data || [];\n");
    }
    WriteLiteral("      }\n");
    WriteLiteral("    });\n");
  }
}
    this.filter();
  }

@{
  foreach (var field in idFilterFields)
  {
    var navigationName = field.NavigationName ?? field.Name.Replace("Id", "");
    var pascalNavigationName = navigationName.Substring(0, 1).ToUpper() + navigationName.Substring(1);
    var camelField = field.Name.ToCamelCase();
    var itemDtoType = pascalNavigationName + "ItemDto";
    WriteLiteral($"  get{field.Name}(): Observable<PageList<{itemDtoType}>> {{\n");
    WriteLiteral($"    return this.adminClient.{pascalNavigationName.ToCamelCase()}.list({{ pageIndex: 1, pageSize: 100 }});\n");
    WriteLiteral("  }\n\n");
  }
}

  filter(): void {
    this.adminClient.@(camel).list(this.filter).subscribe((res) => {
      this.dataSource.data = (res.data || []);
      this.total = (res.count ?? res.data?.length ?? this.dataSource.data.length);
    });
  }

  pageChanged(e: any) {
    this.filter.pageIndex = e.pageIndex + 1;
    this.filter.pageSize = e.pageSize;
    this.filter();
  }

  openAdd() {
    const ref = this.dialog.open(@(ModelName)Add, { width: '800px' });
    ref.afterClosed().subscribe((r: boolean) => { if (r) this.filter(); });
  }

  openEdit(id: string) {
    const ref = this.dialog.open(@(ModelName)Edit, { width: '800px', data: { id } });
    ref.afterClosed().subscribe((r: boolean) => { if (r) this.filter(); });
  }

  openDetail(id: string) {
    this.dialog.open(@(ModelName)Detail, { width: '800px', data: { id } });
  }

  deleteItem(id: string) {
    const ref = this.dialog.open(ConfirmDialogComponent, {
      data: {
        title: this.translate.instant('common.confirm'),
        content: this.translate.instant('common.deleteConfirm')
      }
    });
    ref.afterClosed().subscribe((ok: boolean) => {
      if (ok) { this.adminClient.@(camel).delete(id).subscribe(() => this.filter()); }
    });
  }
}