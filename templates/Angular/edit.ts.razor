@* Edit component TypeScript (keeps formatting and proper newline structure) *@
@{
    var name = ModelName ?? "Model";
    var camel = (ModelName ?? "Model").ToCamelCase();
    var module = (Namespace ?? string.Empty).Split('.').LastOrDefault()?.ToHyphen() ?? string.Empty;
  var hasEnumUpdate = UpdatePropertyInfos.Any(p => p.IsEnum);
  var enumImports = hasEnumUpdate ? ", ToKeyValuePipe, EnumTextPipe" : string.Empty;
}
import { Component, Inject, OnInit } from '@@angular/core';
import { AbstractControl, FormBuilder, FormGroup, Validators } from '@@angular/forms';
import { MatDialogRef, MAT_DIALOG_DATA } from '@@angular/material/dialog';
import { MatCheckboxModule } from '@@angular/material/checkbox';
import { TranslateService } from '@@ngx-translate/core';
import { AdminClient } from 'src/app/services/admin/admin-client';
import { I18N_KEYS } from 'src/app/share/i18n-keys';
import { CommonFormModules } from 'src/app/share/shared-modules';
@{ if (hasEnumUpdate) { WriteLiteral("import { ToKeyValuePipe } from 'src/app/share/pipe/to-key-value.pipe';\n"); WriteLiteral("import { EnumTextPipe } from 'src/app/pipe/admin/enum-text.pipe';\n"); } }
import { @(ModelName)UpdateDto } from 'src/app/services/admin/models/@(module)/@(ModelName.ToHyphen())-update-dto.model';
import { @(ModelName)DetailDto } from 'src/app/services/admin/models/@(module)/@(ModelName.ToHyphen())-detail-dto.model';

@{ WriteLiteral("@Component({\n  selector: 'app-" + camel + "-edit',\n  imports: [CommonFormModules, MatCheckboxModule" + enumImports + "],\n  templateUrl: './edit.html'\n})\n"); }
export class @(ModelName)Edit implements OnInit {

  i18nKeys = I18N_KEYS;

  form!: FormGroup;
  id?: string;

  constructor(
    private fb: FormBuilder,
    private adminClient: AdminClient,
    private dialogRef: MatDialogRef<@(ModelName)Edit>,
    @@Inject(MAT_DIALOG_DATA) public data: any,
    private translate: TranslateService
  ) {
    this.buildForm();
    this.id = data?.id;
  }

  ngOnInit() {
    if (this.id) {
      this.adminClient.@(camel).detail(this.id).subscribe((res: @(ModelName)DetailDto) => this.form.patchValue(res));
    }
  }

  buildForm() {
    this.form = this.fb.group({
      @( string.Join(",\n      ", UpdatePropertyInfos.Select(p => "\"" + p.Name.ToCamelCase() + "\": [null, [" + (p.IsRequired ? "Validators.required" : "") + (p.MinLength.HasValue ? ((p.IsRequired ? ", " : "") + "Validators.minLength(" + p.MinLength + ")") : "") + (p.MaxLength.HasValue ? ((p.IsRequired || p.MinLength.HasValue) ? ", " : "") + "Validators.maxLength(" + p.MaxLength + ")" : "") + "]]")) )
    });
  }

  getValidatorMessage(control: AbstractControl | null): string {
    if (!control || !control.errors) { return ''; }
    const errors = control.errors;
    const key = Object.keys(errors)[0];
    const params = errors[key];
    return this.translate.instant(`validation.${key.toLowerCase()}`, params);
  }

  submit() {
    if (this.form.invalid) return;
    if (!this.id) return;
    this.adminClient.@(camel).update(this.id, this.form.value as @(ModelName)UpdateDto).subscribe(() => this.dialogRef.close(true));
  }

  close(result: boolean) { this.dialogRef.close(result); }
}